set -e

if [ -f /_firstrun ]; then

  if [ ! -d "/usr/share/webapps" ]; then mkdir /usr/share/webapps ;fi
  [ "$(ls -A /usr/share/webapps)" ] || echo -e "<?PHP\nphpinfo ();\n?>" > /usr/share/webapps/index.php

  if [ $(grep -c '^hiawatha:' /etc/passwd) = 1 ]; then
	addgroup hiawatha www-data
	sed -i "s*user = nobody*user = hiawatha*g" /etc/php/php-fpm.conf
	sed -i "s*group = nobody*group = www-data*g" /etc/php/php-fpm.conf

	sed -i "s*\# DEFAULT WEBSITE*FastCGIserver \{\n        FastCGIid = PHP5\n        ConnectTo = 127.0.0.1:9000\n        Extension = php\n        SessionTimeout = 600\n\}\n\n\# DEFAULT WEBSITE*g" /etc/hiawatha/hiawatha.conf
	sed -i "s*\#CGIhandler = /usr/bin/php-cgi:php*CGIhandler = /usr/bin/php-cgi:php*g" /etc/hiawatha/hiawatha.conf
	sed -i "s*/var/log/hiawatha/error.log*/var/log/hiawatha/error.log \nExecuteCGI = yes\n*g" /etc/hiawatha/hiawatha.conf
	sed -i "s#/var/log/hiawatha/error.log#/var/log/hiawatha/error.log\n\#ReverseProxy ^/.* http://www.example.com:80/#g" /etc/hiawatha/hiawatha.conf

	chown -R hiawatha:www-data /usr/share/webapps
  	rm /fpm.conf
  else
  	echo "No Hiawatha found."
  fi
  
  if [ $(grep -c '^nginx:' /etc/passwd) = 1 ]; then
	addgroup nginx www-data
	sed -i "s*user = nobody*user = nginx*g" /etc/php/php-fpm.conf
	sed -i "s*group = nobody*group = www-data*g" /etc/php/php-fpm.conf

	sed -i "s*root /usr/share/nginx/html\;*root /usr/share/nginx/html\;\n        include /etc/nginx/fpm.conf\;\n*g" /etc/nginx/localhost.site
        cp -a /etc/nginx/localhost.site  /etc/nginx/sites-enabled/example.site
        sed -i "s*/usr/share/nginx/html*/usr/share/webapps*g" /etc/nginx/sites-enabled/example.site

        chown -R nginx:www-data /usr/share/webapps
	mv /fpm.conf /etc/nginx/fpm.conf
  	sed -i -e '15,20d' /etc/service/nginx/setup
  else
  	"No NGINX found."
  fi

  rm /_firstrun

fi

if [ ! -d /tmp ]; then
        mkdir  /tmp
fi
chmod 777 /tmp
