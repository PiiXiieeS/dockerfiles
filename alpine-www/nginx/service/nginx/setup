set -e


if [ ! -d /etc/nginx/tls ]; then
	mkdir  /etc/nginx/tls
fi

if find "/etc/nginx/tls" -mindepth 1 -print | grep -q .; then
	echo -e "\n[i] /tls not empty"
else
	echo -e "\n[i] No certificate found in /tls.\n Create one with OpenSSL." 
	apk -U add openssl
 	openssl genrsa -out /etc/nginx/tls/nginx.pem 4096
 	openssl req -new -x509 -days 3650 -key /etc/nginx/tls/nginx.pem -out /etc/nginx/tls/nginx.crt -subj "/C=US/CN=0.0.0.0"
	apk del openssl
	rm -rf /var/cache/apk/* /usr/share/doc /usr/share/man/ /usr/share/info/* /var/cache/man/* /var/tmp /tmp/*
fi

if find "/etc/nginx/sites-enabled" -mindepth 1 -name "*.site" -print | grep -q .; then
        echo -e "[i] Site for nginx found.\n"
else
	cp -a /etc/nginx/localhost.site /etc/nginx/sites-enabled/example.site
fi

chown -R nginx:www-data /var/lib/nginx
chmod -R 777 /var/lib/nginx/tmp
