set -e

 if [ ! -d /var/mahara/data ]; then
	mkdir -p /var/mahara/data
 fi
 chown -R nginx:www-data /var/mahara/data
 chmod 755 /var/mahara/data

MAHARA_WWWROOT=${MAHARA_WWWROOT:-/mahara/}
MAHARA_EMAIL=${MAHARA_EMAIL:-contact@domain.org}
MAHARA_DB=${MAHARA_DB:-mahara}
MAHARA_DB_USER=${MAHARA_DB_USER:-mahara}
MAHARA_DB_PASS=${MAHARA_DB_PASS:-$(pwgen -s -1 16)}
MAHARA_SALD=${MAHARA_SALD:-$(pwgen -s -1 16)}
MAHARA_ADMPASS=${MAHARA_ADMPASS:-mahara}
DBHOST=${DBHOST:-db}
DBADMIN=${DBADMIN:-$DB_ENV_DBUSER}
DBPASS=${DBPASS:-$DB_ENV_DBPASS}
ELASTICSEARCH_HOST=${ELASTICSEARCH_HOST:-127.0.0.1}
LANGUAGE=${LANGUAGE:-de}
INSTALL=${INSTALL:-normal}

pre_start_action() {

  if [ -f /etc/nginx/sites-enabled/example.site ]; then
        rm /etc/nginx/sites-enabled/example.site
  fi
  if [ ! -f /etc/nginx/sites-enabled/mahara.site ]; then
        cp /etc/nginx/mahara.site /etc/nginx/sites-enabled/mahara.site
        chown nginx:www-data /etc/nginx/sites-enabled/mahara.site
  fi

if [ -z "$DB_PORT_3306_TCP_ADDR" ]; then
	echo >&2 'error: missing MYSQL_PORT_3306_TCP environment variable'
	echo >&2 '  Did you forget to --link some_mysql_container:db ?'
	exit 1
fi

    if [ ! -f /usr/share/webapps/mahara/config.php ]; then
  	cp -a /usr/share/webapps/mahara/config-dist.php /usr/share/webapps/mahara/config.php
  	sed -i "s|dbtype   = 'postgres'|dbtype   = 'mysql'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|dbname   = ''|dbname   = '$MAHARA_DB'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|dbuser   = ''|dbuser   = '$MAHARA_DB_USER'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|dbpass   = ''|dbpass   = '$MAHARA_DB_PASS'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|dbhost   = 'localhost'|dbhost   = '$DBHOST'|g" /usr/share/webapps/mahara/config.php
  	sed -i 's|\/\/ \$cfg->wwwroot|\$cfg->wwwroot|g' /usr/share/webapps/mahara/config.php
  	sed -i "s|wwwroot = 'https:\/\/myhost.com\/mahara\/'|wwwroot = '$MAHARA_WWWROOT'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|dataroot = '\/path\/to\/uploaddir'|dataroot = '\/var\/mahara\/data'|g" /usr/share/webapps/mahara/config.php
  	sed -i 's|\/\/ \$cfg->passwordsaltmain|\$cfg->passwordsaltmain|g' /usr/share/webapps/mahara/config.php
  	sed -i "s|passwordsaltmain = 'some long random string here with lots of characters'|passwordsaltmain = '$MAHARA_SALD'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s|emailcontact = ''|emailcontact = '$MAHARA_EMAIL'|g" /usr/share/webapps/mahara/config.php
  	sed -i "s#\/\/ closing php tag intentionally omitted to prevent whitespace issues#\$cfg->cleanurls = true;\n\$cfg->cleanurlinvalidcharacters = '/[^a-zA-Z0-9]+/';\n\$cfg->cleanurlvalidate = '/^[a-z0-9-]*\$/';\n\$cfg->cleanurlusereditable = true;\n\n\$cfg->log_dbg_targets     = LOG_TARGET_SCREEN | LOG_TARGET_ERRORLOG;\n\$cfg->log_info_targets    = LOG_TARGET_SCREEN | LOG_TARGET_ERRORLOG;\n\$cfg->log_warn_targets    = LOG_TARGET_SCREEN | LOG_TARGET_ERRORLOG;\n\$cfg->log_environ_targets = LOG_TARGET_SCREEN | LOG_TARGET_ERRORLOG;\n\n\$cfg->plugin_search_elasticsearch_host = '$ELASTICSEARCH_HOST';\n\n\/\/ closing php tag intentionally omitted to prevent whitespace issues#g" /usr/share/webapps/mahara/config.php
  	chown nginx:www-data /usr/share/webapps/mahara/config.php
	fi

## Language pack
# German
cd /tmp/
if curl --output /dev/null --silent --head --fail "http://langpacks.mahara.org/${LANGUAGE}-MAHARA_VERSION_STABLE.tar.gz"; then
  wget http://langpacks.mahara.org/${LANGUAGE}-MAHARA_VERSION_STABLE.tar.gz
else
 wget http://langpacks.mahara.org/${LANGUAGE}-master.tar.gz
fi

if [ ! -d /var/mahara/data/langpacks  ]; then
  mkdir /var/mahara/data/langpacks
fi
tar -xvzf ${LANGUAGE}-* -C /var/mahara/data/langpacks/
chown -R nginx:www-data /var/mahara/data/langpacks/${LANGUAGE}.utf8
rm -r /tmp/${LANGUAGE}*
echo " " && echo "---" && echo " "

}

post_start_action() {

if [ "$INSTALL" == "silent" ]; then
    	  echo "Create user and database"
    	  mysql -u${DBADMIN} -p${DBPASS} -h $DBHOST <<-EOF
    	  CREATE DATABASE IF NOT EXISTS $MAHARA_DB CHARACTER SET utf8 COLLATE utf8_general_ci;
    	  GRANT ALL PRIVILEGES ON $MAHARA_DB.* TO '$MAHARA_DB_USER'@'%' IDENTIFIED BY '$MAHARA_DB_PASS';
    	  FLUSH PRIVILEGES;
EOF
    	  sed -i "s|dbuser   = '$MAHARA_DB_USER'|dbuser   = '$DBADMIN'|g" /usr/share/webapps/mahara/config.php
    	  sed -i "s|dbpass   = '$MAHARA_DB_PASS'|dbpass   = '$DBPASS'|g" /usr/share/webapps/mahara/config.php
    	  echo -e "\n---\nInstalling Mahara. Stay tuned!\n"
    	  sudo -u nginx php /usr/share/webapps/mahara/admin/cli/install.php --verbose --adminpassword='$MAHARA_ADMPASS' --adminemail=$MAHARA_EMAIL
	  echo -e "\n[i] Installed with \nadminpassword = $MAHARA_ADMPASS \nadminemail = $MAHARA_EMAIL\n---\n"
    	  sed -i "s|dbuser   = '$DBADMIN'|dbuser   = '$MAHARA_DB_USER'|g" /usr/share/webapps/mahara/config.php
    	  sed -i "s|dbpass   = '$DBPASS'|dbpass   = '$MAHARA_DB_PASS'|g" /usr/share/webapps/mahara/config.php
	  echo -e "\n[i] Set automatic configuration:\n  DB = $MAHARA_DB_USER \n  DB User = $MAHARA_DB \n  DB PASS = $MAHARA_DB_PASS \n  SALD = $MAHARA_SALD\n---\n"
fi
chown -R nginx:www-data /var/mahara/data
rm /__firstrun

}

if [ -f /__firstrun ]; then

  pre_start_action
  post_start_action

fi
