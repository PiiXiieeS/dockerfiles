set -e

OCDIR=/usr/share/webapps/owncloud
OC_DB=${OC_DB:-owncloud}
DBHOST=${DBHOST:-db}
DBADMIN=${DBADMIN:-$DB_ENV_DBUSER}
DBPASS=${DBPASS:-$DB_ENV_DBPASS}
OCADMIN=${OCADMIN:-ocadmin}
OCPASS=${OCPASS:-ocadmin}
OCSALT=${OCSALT:-$(pwgen -s -1 16)}

if [ ! -z "$MYSQL_PORT_3306_TCP_ADDR" ]; then
	sed -i "s/.*dbhost.*/  'dbhost' => '$MYSQL_PORT_3306_TCP_ADDR',/" $OCDIR/config/config.php
fi

if [ -f /secondrun ]; then
if [ "`mysql -u$DBADMIN -p$DBPASS -h $DBHOST -se'USE $OC_DB;' 2>&1`" == "" ]; then
        echo "$OC_DB exist"
        echo "So I expect a config.php under $OCDIR"
elif [ -f $OCDIR/config/config.php ]; then
        echo "config.php is expecting under $OCDIR"
else
        mv /autoconfig.php  $OCDIR/config/autoconfig.php
        chown -R hiawatha:www-data  $OCDIR/config/autoconfig.php
        sed -i "s*DBUSER*$DBADMIN*g"  $OCDIR/config/autoconfig.php
        sed -i "s*DBPASS*$DBPASS*g"  $OCDIR/config/autoconfig.php
        sed -i "s*DBHOST*$DBHOST*g"  $OCDIR/config/autoconfig.php
        sed -i "s*DBNAME*$OC_DB*g"  $OCDIR/config/autoconfig.php
        sed -i "s*OCADMIN*$OCADMIN*g"  $OCDIR/config/autoconfig.php
        sed -i "s*OCPASS*$OCPASS*g"  $OCDIR/config/autoconfig.php
        sed -i "s*OCSALT*$OCSALT*g"  $OCDIR/config/autoconfig.php

        #echo -e  "<?php \n\$CONFIG = array (\n  'memcache.local' => '\\OC\\Memcache\\APCu',\n'memcache.locking' => '\\OC\\Memcache\\Redis',\n'redis' =>array (\n    'host' => 'redis',\n    'port' => 6379,\n  ),\n);\n" > $OCDIR/config/config.php
        chown hiawatha:www-data -R $OCDIR/config
        
        echo -e "\n[i] Set automatic configuration:\n OC admin: $OCADMIN\n OC pass: $OCPASS\n Salt: $OCSALT\n---\n"

fi
 if [ ! -d /var/owncloud/data ]; then
	mkdir -p /var/owncloud/data
 fi
 chmod 755 /var/owncloud/data
 chown hiawatha:www-data /var/owncloud/data
 if [ -f /etc/hiawatha/sites-enabled/example.conf ]; then
	mv /etc/hiawatha/sites-enabled/example.conf /etc/hiawatha/sites-enabled/owncloud.conf
 fi
 rm /secondrun

fi
