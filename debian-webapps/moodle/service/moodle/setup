set -e

MOODLE_DB=${MOODLE_DB:-moodle}
MOODLE_PASS=${MOODLE_PASS:-$(pwgen -s -1 16)}
MOODLE_SALD=${MOODLE_SALD:-$(pwgen -s -1 16)}
MOODLE_WWWROOT=${MOODLE_WWWROOT:-/moodle}
DBADMIN=${DBADMIN:-$DB_ENV_USER}
DBPASS=${DBPASS:-$DB_ENV_PASS}
DBHOST=${DBHOST:-db}
INSTALL=${INSTALL:-normal}

pre_start_action() {

  sed -i -e '9,12d' /etc/service/php-fpm/setup
  if [ -f /etc/nginx/sites-enabled/example.site ]; then
  	rm /etc/nginx/sites-enabled/example.site
  fi
  if [ ! -f /etc/nginx/sites-enabled/moodle.site ]; then
  	cp /etc/nginx/moodle.site /etc/nginx/sites-enabled/moodle.site
  fi

  if [ $INSTALL == "silent" ]; then
    if [ ! -f $APPDIR/config.php ]; then
    	export APPDIR="/usr/share/webapps/moodle"
    	cp -ax $APPDIR/config-dist.php $APPDIR/config.php
  	sed -i "s*pgsql*mariadb*g" $APPDIR/config.php
  	sed -i "s*localhost*$DBHOST*g" $APPDIR/config.php
  	sed -i "s*username*$MOODLE_DB*g" $APPDIR/config.php
  	sed -i "s*password*$MOODLE_PASS*g" $APPDIR/config.php
  	sed -i "s*example.com*$MOODLE_WWWROOT*g" $APPDIR/config.php
  	sed -i "s*\/home\/example\/moodledata*\/var\/moodledata*g" $APPDIR/config.php
  	chown www-data:www-data $APPDIR/config.php
  	chown -R www-data:www-data /var/moodledata
    fi

    echo "Create database user $MOODLE_DB and database $MOODLE_DB"
    mysql -u$DBADMIN --password=$DBPASS -h $DBHOST <<-EOF
      CREATE DATABASE IF NOT EXISTS $MOODLE_DB CHARACTER SET utf8;
      GRANT ALL PRIVILEGES ON $MOODLE_DB.* TO $MOODLE_DB IDENTIFIED BY '$MOODLE_PASS';
      FLUSH PRIVILEGES;
      use $MOODLE_DB;
      SET SESSION sql_mode=STRICT_ALL_TABLES;
      SET GLOBAL innodb_file_per_table=1;
      SET GLOBAL innodb_file_format=Barracuda;
EOF
  fi
}

post_start_action() {

  rm /__firstrun
  echo -e "\n[i] Set automatic configuration:\n  DB = $MOODLE_DB \n  DB User = $MOODLE_DB_USER \n  DB PASS = $MOODLE_DB_PASS \n  SALD = $MOODLE_SALD\n  www_root:$MOODLE_WWWROOT\n---\n"
}

if [ -f /__firstrun ]; then

  pre_start_action
  post_start_action

fi
