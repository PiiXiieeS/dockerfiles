#!/bin/execlineb -P

foreground {
 if -t { s6-test ! -d /etc/nginx/tls }
 if { s6-echo "[i] Create tls folder" }
 if { s6-mkdir /etc/nginx/tls }
}

if -t { s6-test ! -f /etc/nginx/tls/nginx.pem }
if { s6-echo "[i] Create a server certificate" }
if { apt-get update }
if { apt-get install -y openssl }
if { export RANDFILE /dev/null openssl genrsa -out /etc/nginx/tls/nginx.pem 4096 }
if { openssl req -new -x509 -days 3650 -key /etc/nginx/tls/nginx.pem -out /etc/nginx/tls/nginx.crt -subj "/C=US/CN=0.0.0.0" }
if { s6-envuidgid www-data s6-chown -U -- /etc/nginx/tls/nginx.pem }
if { s6-envuidgid www-data s6-chown -U -- /etc/nginx/tls/nginx.crt }
if { apt-get purge -y openssl }
if { apt-get clean }
if { s6-rmrf  /usr/share/doc /usr/share/man/ /usr/share/info/* /var/cache/man/* /var/tmp }
