#!/usr/bin/env bash
# ------------------------------------------------------------------
# [Christian-Maximilian Steier]
# Build a small AlpineLinux Docker image with mahara        
# ------------------------------------------------------------------

DIR="$(cd -P "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NAMESPACE="maxder"

if [ $(uname -m) == "armv6l" ]; then
	DISTRO="rpi-alpine"
	COUNT="2"
	CONNECTIONS="256"
else
	DISTRO="alpine"
	COUNT="4"
	CONNECTIONS="1024"
fi
sed -i "s*PLACEHOLDER*${DISTRO}*g" $DIR/Dockerfile
sed -i "s*COUNT*${COUNT}*g" $DIR/conf/nginx.conf
sed -i "s*CONNECTIONS*${CONNECTIONS}*g" $DIR/conf/nginx.conf

CONTAINER_NAME="mahara"
IMAGENAME="${NAMESPACE}/${DISTRO}-${CONTAINER_NAME}:edge"

build() {
  docker build --rm -t $IMAGENAME .

  [ $? != 0 ] && error "Docker image build failed !" && exit 100
}

run() {

# At least three arguments should be present
if [[ "$#" < 4 ]]; then
	echo -e "\nYou must specify at least four arguments: \n * first for database \n * second for database user \n * third for database password \n * and fourth for database container \nFor example: ./do run mahara user password mysql"
	exit 1
fi
  docker run -d --hostname $CONTAINER_NAME --name $CONTAINER_NAME -p 127.0.0.1:8280:80 -e MAHARA_DB=$1 -e MAHARA_DB_USER=$2 -e MAHARA_DB_PASS=$3 --link=$4:db $IMAGENAME
  docker logs $CONTAINER_NAME
  [ $? != 0 ] && error "Docker image build failed !" && exit 100
}

silent() {
  docker run -d --hostname $CONTAINER_NAME --name $CONTAINER_NAME -p 127.0.0.1:8080:80 -e INSTALL="silent" --link=mysql:db $IMAGENAME
  docker logs $CONTAINER_NAME
  [ $? != 0 ] && error "Docker image build failed !" && exit 100
}

stop() {
  docker stop $CONTAINER_NAME
}

start() {
  docker start $CONTAINER_NAME
}

remove() {
  log "Removing previous container $CONTAINER_NAME" && \
      docker rm -f $CONTAINER_NAME &> /dev/null || true
}

log() {
  echo -e "$BLUE > $1 $NORMAL"
}

error() {
  echo ""
  echo -e "$RED >>> ERROR - $1$NORMAL"
}

help() {
  echo "-----------------------------------------------------------------------"
  echo "                      Available commands                              -"
  echo "-----------------------------------------------------------------------"
  echo -e -n "$BLUE"
  echo "   > build - Build the Docker image"
  echo "   > run - Start first time"
  echo "   > silen - Start first time and install Mahara silent"
  echo "   > stop - Stop $CONTAINER_NAME"
  echo "   > start - Start $CONTAINER_NAME"
  echo "   > remove - Remove $CONTAINER_NAME"
  echo "   > help - Display this help"
  echo -e -n "$NORMAL"
  echo "-----------------------------------------------------------------------"

}

# Output colors
NORMAL="\\033[0;39m"
RED="\\033[1;31m"
BLUE="\\033[1;34m"

$*
